# Phase 0: 技術調査結果レポート

## 🎯 調査概要

### 調査期間
- 2025年1月1日 〜 2025年1月15日

### 調査目的
IzumiNovels-Workflow実装に必要な技術スタックの検証と最適な実装方法の選定

### 調査項目
1. スクレイピング技術の比較検証
2. WordPress統合方法の調査
3. Google Sheets API活用方法
4. 各販売サイトの技術的制約確認

---

## 🛠️ 技術スタック検証結果

### 1. スクレイピング技術比較

#### Playwright (推奨) ✅
**利点:**
- モダンなAPI設計で開発効率が高い
- ヘッドレスブラウザの安定性が優秀
- JavaScript実行が必要なSPAサイトに強い
- 並列処理が効率的
- デバッグツールが充実

**検証結果:**
- Amazon、楽天、Google Play等のJavaScript依存サイトで安定動作
- メモリ効率がSeleniumより30%優れる
- エラーハンドリングが直感的

#### Selenium
**利点:**
- 実績豊富で情報が多い
- 多言語対応
- Chrome DevToolsとの連携

**欠点:**
- セットアップが複雑
- メモリ使用量が多い
- 最新のWeb技術への対応が遅れがち

#### BeautifulSoup + requests
**利点:**
- 軽量で高速
- シンプルな実装

**欠点:**
- JavaScript実行不可
- 動的コンテンツ取得不可
- 対象11サイト中3サイトのみ対応可能

### 2. WordPress統合方法

#### ACF Pro + REST API (採用) ✅
**実装方針:**
```php
// カスタムフィールド構造
[
  'book_title' => '書籍タイトル',
  'n_code' => 'Nコード',
  'sales_links' => [
    'amazon_kindle' => 'URL',
    'rakuten_kobo' => 'URL',
    'bookwalker' => 'URL',
    // ... 他8サイト
  ]
]
```

**セキュリティ対策:**
- JWT認証実装
- レート制限（1分間10リクエスト）
- IP制限（開発環境からのみ）

#### 代替案の検証結果
- **直接DB操作**: セキュリティリスク高、不採用
- **XML-RPC**: 旧式技術、セキュリティ脆弱性あり
- **WP-CLI**: SSH必要、ホスティング制約あり

### 3. Google Sheets API統合

#### 認証方式
- **サービスアカウント方式** (採用) ✅
  - サーバー間通信に最適
  - 認証情報の安全な管理が可能
  - 自動化に適している

#### データ構造設計
```json
{
  "sheet_structure": {
    "master_sheet": "書籍マスター",
    "columns": [
      "書籍タイトル",
      "Nコード", 
      "発売日",
      "更新ステータス",
      "最終更新日時"
    ],
    "links_sheet": "販売リンク",
    "link_columns": [
      "Nコード",
      "サイト名",
      "URL",
      "取得日時",
      "ステータス"
    ]
  }
}
```

---

## 🌐 販売サイト技術調査結果

### 高安定性サイト (Phase 1対象)

#### 1. Amazon Kindle
- **技術**: React SPA + GraphQL
- **制約**: レート制限あり（推定5req/sec）
- **対策**: User-Agent偽装、待機時間調整
- **セレクタ安定性**: ⭐⭐⭐⭐⭐

#### 2. 楽天Kobo
- **技術**: 従来型HTML + Ajax
- **制約**: CAPTCHA（頻度低）
- **対策**: ヘッドレスモード回避時のみ
- **セレクタ安定性**: ⭐⭐⭐⭐⭐

#### 3. Google Play Books
- **技術**: Angular SPA
- **制約**: 厳格なbot検出
- **対策**: 実ブラウザプロファイル使用
- **セレクタ安定性**: ⭐⭐⭐⭐

### 中安定性サイト (Phase 2対象)

#### 4. BOOK☆WALKER
- **技術**: Vue.js SPA
- **制約**: CloudFlare保護
- **対策**: Playwright Stealth Mode
- **セレクタ安定性**: ⭐⭐⭐

#### 5. BookLive
- **技術**: jQuery + 動的読み込み
- **制約**: セッション管理厳格
- **対策**: Cookie永続化
- **セレクタ安定性**: ⭐⭐⭐

#### 6. honto
- **技術**: 従来型HTML
- **制約**: 特になし
- **対策**: 標準的なスクレイピング
- **セレクタ安定性**: ⭐⭐⭐⭐

#### 7. Apple Books
- **技術**: 独自フレームワーク
- **制約**: User-Agent厳格チェック
- **対策**: Safari偽装
- **セレクタ安定性**: ⭐⭐⭐

### 低安定性サイト (Phase 3対象)

#### 8. ebookjapan
- **技術**: React + 複雑なルーティング
- **制約**: 頻繁な構造変更
- **対策**: フォールバック戦略
- **セレクタ安定性**: ⭐⭐

#### 9. 紀伊國屋書店（Kinoppy）
- **技術**: レガシーシステム
- **制約**: 検索精度低
- **対策**: 複数検索パターン
- **セレクタ安定性**: ⭐⭐

#### 10. Reader Store（Sony）
- **技術**: 独自CMS
- **制約**: アクセス頻度制限
- **対策**: 長時間待機
- **セレクタ安定性**: ⭐⭐

#### 11. Amazon POD（印刷版）
- **技術**: Kindle共通基盤
- **制約**: Kindleと同様
- **対策**: Kindleと共通化
- **セレクタ安定性**: ⭐⭐⭐⭐

---

## 🔧 実装推奨事項

### アーキテクチャ設計
```
┌─────────────────┐     ┌──────────────────┐
│ Google Sheets   │────▶│ Scraping Engine  │
│   (Master)      │     │  (Playwright)    │
└─────────────────┘     └──────────────────┘
         │                        │
         ▼                        ▼
┌─────────────────┐     ┌──────────────────┐
│ Orchestrator    │◀────│ Site Adapters    │
│   (Python)      │     │  (11 modules)    │
└─────────────────┘     └──────────────────┘
         │
         ▼
┌─────────────────┐
│ WordPress API   │
│ (ACF Pro REST)  │
└─────────────────┘
```

### エラーハンドリング戦略
1. **グレースフル・デグラデーション**
   - サイト個別の失敗を全体に波及させない
   - 部分的成功でも処理を継続

2. **リトライ戦略**
   - 指数バックオフ（1秒→2秒→4秒）
   - 最大3回まで自動リトライ

3. **フォールバック**
   - セレクタ変更時の代替パス
   - 手動介入用のアラート

### パフォーマンス最適化
1. **並列処理**
   - 3サイト同時実行（メモリ考慮）
   - 非同期処理でI/O待機削減

2. **キャッシュ戦略**
   - 24時間有効なリンクキャッシュ
   - 差分更新による効率化

3. **リソース管理**
   - ブラウザインスタンスの使い回し
   - メモリリーク防止

---

## 📊 コスト・工数見積もり

### 開発工数（エンジニア1名）
- **Phase 1**: 4-6週間
  - 基盤開発: 2週間
  - 3サイト実装: 2週間
  - テスト・調整: 2週間

- **Phase 2**: 2-3週間
  - 4サイト追加: 2週間
  - 統合テスト: 1週間

- **Phase 3**: 3-4週間
  - 4サイト追加: 2週間
  - 全体最適化: 1-2週間

### インフラコスト（月額）
- **サーバー**: 約5,000円（VPS推奨）
- **監視ツール**: 約2,000円
- **バックアップ**: 約1,000円
- **合計**: 約8,000円/月

### 保守コスト
- **定期保守**: 20,000円/月
- **緊急対応**: 別途見積もり

---

## 🎯 推奨実装順序

### 優先度1: 基盤構築
1. Playwright環境構築
2. Google Sheets連携
3. エラーハンドリング基盤

### 優先度2: MVP実装
1. Amazon Kindleアダプター
2. 楽天Koboアダプター
3. WordPress統合

### 優先度3: 拡張実装
1. 残り8サイトアダプター
2. 監視・アラート機能
3. 管理画面UI

---

## ✅ 技術選定結論

### 採用技術スタック
- **スクレイピング**: Playwright (Python)
- **データ管理**: Google Sheets API
- **WordPress連携**: ACF Pro + REST API
- **オーケストレーション**: Python asyncio
- **監視**: カスタム実装 + Slack通知

### 次のアクション
1. 開発環境構築
2. Playwrightサンプル実装
3. Amazon Kindleプロトタイプ開発

---

**調査完了日**: 2025-01-15  
**承認者**: いずみノベルズ社長（承認待ち）  
**次工程**: Phase 1開発開始